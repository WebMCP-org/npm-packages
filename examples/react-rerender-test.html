<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>React Re-render Test - useWebMCP</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .counter {
      font-size: 24px;
      font-weight: bold;
      color: #2196F3;
      margin: 10px 0;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
    }
    button:hover {
      background: #45a049;
    }
    .log {
      background: #f4f4f4;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 10px;
    }
    .log-entry {
      margin: 2px 0;
      padding: 2px 5px;
    }
    .log-register {
      background: #ffeb3b;
      color: #000;
    }
    .log-unregister {
      background: #ff9800;
      color: #fff;
    }
    .log-render {
      color: #666;
    }
    .log-warning {
      background: #f44336;
      color: #fff;
    }
  </style>
</head>
<body>
  <h1>üîÑ React Re-render Test - useWebMCP</h1>

  <div class="section">
    <h2>Test Scenarios</h2>
    <p>This page tests that the useWebMCP hook properly optimizes re-renders:</p>
    <ul>
      <li><strong>Scenario 1:</strong> Changing handler function should NOT re-register tool</li>
      <li><strong>Scenario 2:</strong> Changing inline schema SHOULD trigger warning and re-register</li>
      <li><strong>Scenario 3:</strong> Changing state should NOT re-register tool</li>
    </ul>
  </div>

  <div id="root"></div>

  <script src="../global/dist/index.iife.js"></script>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel" data-type="module">
    const { useState, useMemo, useEffect } = React;

    // Capture console logs
    const originalLog = console.log;
    const originalWarn = console.warn;
    const logs = [];

    console.log = (...args) => {
      const msg = args.join(' ');
      if (msg.includes('Registering tool') || msg.includes('Updated bridge')) {
        logs.push({ type: 'register', msg, time: Date.now() });
      } else if (msg.includes('render')) {
        logs.push({ type: 'render', msg, time: Date.now() });
      }
      originalLog(...args);
    };

    console.warn = (...args) => {
      const msg = args.join(' ');
      logs.push({ type: 'warning', msg, time: Date.now() });
      originalWarn(...args);
    };

    // Mock z for testing (we'll use JSON schema instead)
    function TestComponent() {
      const [count, setCount] = useState(0);
      const [handlerVersion, setHandlerVersion] = useState(1);
      const [useInlineSchema, setUseInlineSchema] = useState(false);
      const [renderCount, setRenderCount] = useState(0);

      // Track renders
      useEffect(() => {
        setRenderCount(prev => prev + 1);
        console.log(`[React] Component render #${renderCount + 1}`);
      });

      // Properly memoized schema (won't change)
      const goodSchema = useMemo(() => ({
        type: 'object',
        properties: {
          count: { type: 'number' }
        },
        required: ['count']
      }), []);

      // Handler that changes every render when handlerVersion changes
      const handler = () => {
        console.log(`[Handler] Version ${handlerVersion}, count: ${count}`);
        return {
          content: [{
            type: 'text',
            text: `Handler v${handlerVersion} executed with count ${count}`
          }]
        };
      };

      // Register tool with useWebMCP (simulated - we'll use direct API)
      useEffect(() => {
        if (!window.navigator?.modelContext) return;

        console.log('[Test] Registering tool...');

        const registration = window.navigator.modelContext.registerTool({
          name: 'test_tool',
          description: 'Test tool for re-render verification',
          inputSchema: useInlineSchema
            ? { type: 'object', properties: {} } // New object every time
            : goodSchema,
          execute: handler
        });

        return () => {
          console.log('[Test] Unregistering tool...');
          registration?.unregister();
        };
      }, [useInlineSchema, goodSchema]); // Note: handler NOT in deps

      const logEntries = logs.slice(-20).map((log, i) => {
        const className = `log-entry log-${log.type}`;
        return <div key={i} className={className}>{log.msg}</div>;
      });

      return (
        <div>
          <div className="section">
            <h2>Component State</h2>
            <div className="counter">Count: {count}</div>
            <div className="counter">Handler Version: {handlerVersion}</div>
            <div className="counter">Render Count: {renderCount}</div>

            <button onClick={() => setCount(count + 1)}>
              Increment Count (Should NOT re-register)
            </button>
            <button onClick={() => setHandlerVersion(handlerVersion + 1)}>
              Change Handler (Should NOT re-register)
            </button>
            <button onClick={() => setUseInlineSchema(!useInlineSchema)}>
              Toggle Inline Schema (WILL re-register)
            </button>
          </div>

          <div className="section">
            <h2>Registration Log</h2>
            <div className="log">
              {logEntries.length > 0 ? logEntries : <div>No logs yet...</div>}
            </div>
          </div>

          <div className="section">
            <h2>Expected Behavior</h2>
            <ul>
              <li>‚úÖ Clicking "Increment Count" should NOT show "Registering tool" log</li>
              <li>‚úÖ Clicking "Change Handler" should NOT show "Registering tool" log</li>
              <li>‚ö†Ô∏è Clicking "Toggle Inline Schema" WILL show "Registering tool" log (expected)</li>
              <li>‚úÖ Only 1 registration at mount, 1 unregister at unmount</li>
            </ul>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<TestComponent />);
  </script>
</body>
</html>
