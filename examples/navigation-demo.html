<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Navigation Handling Demo - WebMCP</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #4CAF50;
      padding-bottom: 10px;
    }
    .section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .tool-card {
      background: #f9f9f9;
      padding: 15px;
      margin: 10px 0;
      border-left: 4px solid #2196F3;
      border-radius: 4px;
    }
    .tool-name {
      font-weight: bold;
      color: #2196F3;
      font-size: 1.1em;
    }
    .tool-description {
      color: #666;
      margin: 5px 0;
    }
    .pattern {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 0.85em;
      font-weight: 500;
    }
    .pattern-good {
      background: #C8E6C9;
      color: #2E7D32;
    }
    .pattern-bad {
      background: #FFCDD2;
      color: #C62828;
    }
    .pattern-special {
      background: #FFE082;
      color: #F57C00;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      margin-right: 5px;
    }
    button:hover {
      background: #45a049;
    }
    button.secondary {
      background: #2196F3;
    }
    button.secondary:hover {
      background: #0b7dda;
    }
    button.danger {
      background: #f44336;
    }
    button.danger:hover {
      background: #da190b;
    }
    .code-block {
      background: #f4f4f4;
      padding: 10px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      overflow-x: auto;
      margin: 10px 0;
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-weight: 500;
    }
    .status.info {
      background: #E3F2FD;
      color: #1976D2;
    }
    .status.success {
      background: #C8E6C9;
      color: #2E7D32;
    }
    .status.warning {
      background: #FFE082;
      color: #F57C00;
    }
    .status.error {
      background: #FFCDD2;
      color: #C62828;
    }
    .instructions {
      background: #FFF9C4;
      padding: 15px;
      border-left: 4px solid #FBC02D;
      border-radius: 4px;
      margin: 15px 0;
    }
    .instructions strong {
      color: #F57C00;
    }
  </style>
</head>
<body>
  <h1>üß≠ WebMCP Navigation Handling Demo</h1>

  <div class="status info">
    <strong>Status:</strong> WebMCP initialized. Use Chrome DevTools MCP to test these navigation patterns.
  </div>

  <div class="instructions">
    <strong>üìã Testing Instructions:</strong><br>
    1. Open Chrome DevTools (F12 or Cmd+Option+I)<br>
    2. Look for the "MCP" tab (or enable it in settings)<br>
    3. Connect to this page's MCP server<br>
    4. Try calling the tools below to test different navigation scenarios<br>
    5. Watch the console for navigation metadata logging
  </div>

  <div class="section">
    <h2>‚úÖ Good Patterns (Respond-Then-Navigate)</h2>
    <p>These tools follow the correct pattern: response returned BEFORE navigation</p>

    <div class="tool-card">
      <div class="tool-name">navigate_to_docs <span class="pattern pattern-good">GOOD PATTERN</span></div>
      <div class="tool-description">Navigate to documentation (correct pattern with setTimeout)</div>
      <div class="code-block">
        Call tool: navigate_to_docs<br>
        Args: { "section": "getting-started" }
      </div>
    </div>

    <div class="tool-card">
      <div class="tool-name">search_and_navigate <span class="pattern pattern-good">GOOD PATTERN</span></div>
      <div class="tool-description">Search and optionally navigate to first result</div>
      <div class="code-block">
        Call tool: search_and_navigate<br>
        Args: { "query": "webmcp", "autoNavigate": true }
      </div>
    </div>

    <div class="tool-card">
      <div class="tool-name">delayed_navigation <span class="pattern pattern-good">GOOD PATTERN</span></div>
      <div class="tool-description">Navigate with a longer delay (3 seconds)</div>
      <div class="code-block">
        Call tool: delayed_navigation<br>
        Args: { "url": "https://example.com", "delayMs": 3000 }
      </div>
    </div>
  </div>

  <div class="section">
    <h2>‚ùå Bad Patterns (Navigate-Then-Respond)</h2>
    <p>These tools demonstrate INCORRECT patterns - response lost during navigation</p>

    <div class="tool-card">
      <div class="tool-name">bad_immediate_navigate <span class="pattern pattern-bad">BAD PATTERN</span></div>
      <div class="tool-description">‚ö†Ô∏è Navigates immediately without response (anti-pattern)</div>
      <div class="code-block">
        Call tool: bad_immediate_navigate<br>
        Args: { "url": "https://example.com" }
      </div>
    </div>
  </div>

  <div class="section">
    <h2>‚è±Ô∏è Timeout & Interruption Testing</h2>
    <p>These tools help test timeout and beforeunload mechanisms</p>

    <div class="tool-card">
      <div class="tool-name">slow_tool <span class="pattern pattern-special">TEST TIMEOUT</span></div>
      <div class="tool-description">Takes 5 seconds to complete (tests timeout mechanism)</div>
      <div class="code-block">
        Call tool: slow_tool<br>
        Args: { "durationMs": 5000 }
      </div>
    </div>

    <div class="tool-card">
      <div class="tool-name">very_slow_tool <span class="pattern pattern-special">TEST TIMEOUT</span></div>
      <div class="tool-description">Takes 60 seconds (will timeout with default 30s setting)</div>
      <div class="code-block">
        Call tool: very_slow_tool<br>
        Args: {}
      </div>
    </div>
  </div>

  <div class="section">
    <h2>üéÆ Manual Test Controls</h2>
    <p>Use these buttons to manually trigger different scenarios</p>

    <button onclick="simulateUserNavigation()">
      Simulate User Navigation (Back Button)
    </button>
    <button class="secondary" onclick="navigateToExample()">
      Navigate to Example.com
    </button>
    <button class="danger" onclick="window.location.reload()">
      Reload Page
    </button>
  </div>

  <div class="section">
    <h2>üìä Tool List</h2>
    <div id="tool-list">Loading...</div>
  </div>

  <!-- Use IIFE build which auto-initializes -->
  <script src="../global/dist/index.iife.js"></script>

  <script type="module">
    // Wait for auto-initialization
    await new Promise(resolve => setTimeout(resolve, 100));

    // ============================================================================
    // GOOD PATTERN TOOLS
    // ============================================================================

    navigator.modelContext.registerTool({
      name: 'navigate_to_docs',
      description: 'Navigate to documentation (GOOD: response before navigation)',
      inputSchema: {
        type: 'object',
        properties: {
          section: {
            type: 'string',
            description: 'Documentation section to navigate to'
          },
        },
        required: ['section'],
      },
      async execute(args) {
        const url = `https://modelcontextprotocol.io/docs/${args.section}`;

        console.log('[Demo] ‚úÖ Good pattern: Preparing response BEFORE navigation');

        // 1. Prepare response FIRST
        const response = {
          content: [{
            type: 'text',
            text: `Navigating to documentation: ${url}`,
          }],
          metadata: {
            willNavigate: true,
            navigationUrl: url,
            navigationTiming: 'immediate',
          },
        };

        // 2. Schedule navigation AFTER return (100ms delay)
        setTimeout(() => {
          console.log('[Demo] Now navigating to:', url);
          window.location.href = url;
        }, 100);

        // 3. Return response BEFORE navigation
        return response;
      },
    });

    navigator.modelContext.registerTool({
      name: 'search_and_navigate',
      description: 'Search and optionally navigate to first result (GOOD: conditional navigation)',
      inputSchema: {
        type: 'object',
        properties: {
          query: {
            type: 'string',
            description: 'Search query'
          },
          autoNavigate: {
            type: 'boolean',
            description: 'Automatically navigate to first result',
          },
        },
        required: ['query'],
      },
      async execute(args) {
        // Simulate search
        const results = [
          { title: 'WebMCP Documentation', url: 'https://modelcontextprotocol.io' },
          { title: 'GitHub Repository', url: 'https://github.com/modelcontextprotocol' },
        ];

        console.log('[Demo] Search results:', results);

        if (args.autoNavigate && results.length > 0) {
          const targetUrl = results[0].url;

          console.log('[Demo] ‚úÖ Good pattern: Preparing navigation response');

          const response = {
            content: [{
              type: 'text',
              text: `Found ${results.length} results. Navigating to: ${targetUrl}`,
            }],
            structuredContent: {
              results,
              navigatingTo: targetUrl
            },
            metadata: {
              willNavigate: true,
              navigationUrl: targetUrl,
              navigationTiming: 'immediate',
            },
          };

          setTimeout(() => {
            console.log('[Demo] Now navigating to search result:', targetUrl);
            window.location.href = targetUrl;
          }, 100);

          return response;
        }

        return {
          content: [{
            type: 'text',
            text: `Found ${results.length} results.`,
          }],
          structuredContent: { results },
        };
      },
    });

    navigator.modelContext.registerTool({
      name: 'delayed_navigation',
      description: 'Navigate with configurable delay (GOOD: delayed timing)',
      inputSchema: {
        type: 'object',
        properties: {
          url: {
            type: 'string',
            description: 'URL to navigate to'
          },
          delayMs: {
            type: 'number',
            description: 'Delay before navigation in milliseconds',
          },
        },
        required: ['url', 'delayMs'],
      },
      async execute(args) {
        console.log('[Demo] ‚úÖ Good pattern: Delayed navigation with metadata');

        const response = {
          content: [{
            type: 'text',
            text: `Will navigate to ${args.url} in ${args.delayMs}ms`,
          }],
          metadata: {
            willNavigate: true,
            navigationUrl: args.url,
            navigationTiming: 'delayed',
            navigationDelayMs: args.delayMs,
          },
        };

        setTimeout(() => {
          console.log('[Demo] Delayed navigation executing:', args.url);
          window.location.href = args.url;
        }, args.delayMs);

        return response;
      },
    });

    // ============================================================================
    // BAD PATTERN TOOLS (Anti-patterns for testing)
    // ============================================================================

    navigator.modelContext.registerTool({
      name: 'bad_immediate_navigate',
      description: 'BAD PATTERN: Navigates immediately without response',
      inputSchema: {
        type: 'object',
        properties: {
          url: {
            type: 'string',
            description: 'URL to navigate to'
          },
        },
        required: ['url'],
      },
      async execute(args) {
        console.error('[Demo] ‚ùå BAD PATTERN: Navigating BEFORE returning response');

        // BAD: Navigate immediately
        window.location.href = args.url;

        // This response will NEVER reach the client
        return {
          content: [{
            type: 'text',
            text: 'This response will be lost during navigation!',
          }],
        };
      },
    });

    // ============================================================================
    // TIMEOUT TESTING TOOLS
    // ============================================================================

    navigator.modelContext.registerTool({
      name: 'slow_tool',
      description: 'Slow tool that takes several seconds to complete',
      inputSchema: {
        type: 'object',
        properties: {
          durationMs: {
            type: 'number',
            description: 'Duration in milliseconds',
          },
        },
        required: ['durationMs'],
      },
      async execute(args) {
        console.log(`[Demo] Slow tool starting (${args.durationMs}ms)`);

        await new Promise(resolve => setTimeout(resolve, args.durationMs));

        console.log('[Demo] Slow tool completed');

        return {
          content: [{
            type: 'text',
            text: `Completed after ${args.durationMs}ms`,
          }],
        };
      },
    });

    navigator.modelContext.registerTool({
      name: 'very_slow_tool',
      description: 'Very slow tool (60s) - will trigger timeout with default settings',
      inputSchema: {
        type: 'object',
        properties: {},
      },
      async execute(_args) {
        console.log('[Demo] Very slow tool starting (60 seconds)');

        await new Promise(resolve => setTimeout(resolve, 60000));

        console.log('[Demo] Very slow tool completed');

        return {
          content: [{
            type: 'text',
            text: 'Completed after 60 seconds',
          }],
        };
      },
    });

    // ============================================================================
    // UTILITY FUNCTIONS
    // ============================================================================

    window.simulateUserNavigation = () => {
      console.log('[Demo] Simulating user navigation (history back)');
      window.history.back();
    };

    window.navigateToExample = () => {
      console.log('[Demo] Navigating to example.com');
      window.location.href = 'https://example.com';
    };

    // Display registered tools
    const toolList = navigator.modelContext.listTools();
    const toolListElement = document.getElementById('tool-list');
    toolListElement.innerHTML = toolList.map(tool => `
      <div class="tool-card">
        <div class="tool-name">${tool.name}</div>
        <div class="tool-description">${tool.description}</div>
      </div>
    `).join('');

    console.log('[Demo] WebMCP Navigation Demo Ready!');
    console.log('[Demo] Registered tools:', toolList.map(t => t.name));
    console.log('[Demo] Use Chrome DevTools MCP to test these tools');
  </script>
</body>
</html>
