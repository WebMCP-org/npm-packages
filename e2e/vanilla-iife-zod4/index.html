<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vanilla IIFE + Zod 4 CDN Test</title>
  <script src="/node_modules/@mcp-b/global/dist/index.iife.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 2rem;
      background: #f0f4f8;
      min-height: 100vh;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }
    h1 { color: #2d3748; margin-bottom: 0.5rem; }
    .subtitle { color: #718096; margin-bottom: 2rem; }
    .badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .badge.zod4 { background: #c6f6d5; color: #22543d; }
    .badge.iife { background: #e9d5ff; color: #581c87; }
    .section {
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: #f7fafc;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }
    .section h2 { color: #2d3748; margin-bottom: 1rem; font-size: 1.25rem; }
    #status { padding: 1rem; border-radius: 6px; margin-bottom: 1rem; }
    #status.success { background: #c6f6d5; color: #22543d; }
    #status.error { background: #fed7d7; color: #742a2a; }
    #results {
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 0.85rem;
      background: #1a202c;
      color: #a0aec0;
      padding: 1rem;
      border-radius: 6px;
      max-height: 400px;
      overflow-y: auto;
    }
    .result-item { padding: 0.5rem 0; border-bottom: 1px solid #2d3748; }
    .result-item:last-child { border-bottom: none; }
    .result-item.success { color: #68d391; }
    .result-item.error { color: #fc8181; }
    .result-item.info { color: #63b3ed; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Vanilla IIFE + Zod 4 CDN Test</h1>
    <p class="subtitle">
      <span class="badge iife">IIFE Build</span>
      <span class="badge zod4">Zod 4.x</span>
      Testing validation with Zod 4 schemas from CDN
    </p>

    <div id="status">Loading Zod 4 from CDN...</div>

    <div class="section">
      <h2>Zod Version Check</h2>
      <div id="zod-version">Checking...</div>
    </div>

    <div class="section">
      <h2>Registered Tools</h2>
      <div id="tools-list">Loading...</div>
    </div>

    <div class="section">
      <h2>Test Results</h2>
      <div id="results"></div>
    </div>
  </div>

  <script type="module">
    // Load Zod 4 from CDN
    import { z } from 'https://cdn.jsdelivr.net/npm/zod@4.3.5/+esm';
    window.z = z;

    const statusEl = document.getElementById('status');
    const resultsEl = document.getElementById('results');
    const toolsListEl = document.getElementById('tools-list');
    const zodVersionEl = document.getElementById('zod-version');

    function log(msg, type = 'info') {
      const div = document.createElement('div');
      div.className = `result-item ${type}`;
      div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      resultsEl.appendChild(div);
      resultsEl.scrollTop = resultsEl.scrollHeight;
    }

    // Check Zod version
    const testSchema = z.string();
    const isZod4 = '_zod' in testSchema;
    const hasNativeToJSONSchema = typeof z.toJSONSchema === 'function';
    zodVersionEl.innerHTML = `
      <p style="color: ${isZod4 ? '#22543d' : '#742a2a'}; font-weight: bold;">
        ${isZod4 ? '✓ Zod 4.x detected (correct)' : '✗ Zod 3.x detected (wrong!)'}
      </p>
      <p style="color: #718096; font-size: 0.85rem;">
        Has _zod: ${'_zod' in testSchema}, Has native toJSONSchema: ${hasNativeToJSONSchema}
      </p>
    `;

    if (!isZod4) {
      statusEl.className = 'error';
      statusEl.textContent = 'Wrong Zod version loaded!';
      log('ERROR: Expected Zod 4.x but got different version', 'error');
      throw new Error('Wrong Zod version');
    }

    async function runTests() {
      if (!window.navigator.modelContext) {
        statusEl.className = 'error';
        statusEl.textContent = 'modelContext not available';
        return;
      }

      statusEl.className = 'success';
      statusEl.textContent = 'Zod 4 loaded + modelContext available - Running tests...';

      const mc = window.navigator.modelContext;

      try {
        // Register tool with Zod 4 schemas
        mc.registerTool({
          name: "zod4-user-validator",
          description: "Validate user data using Zod 4 schemas",
          inputSchema: {
            username: z.string().min(3).max(20).describe("Username (3-20 chars)"),
            email: z.string().email().describe("Valid email address"),
            age: z.number().int().min(18).max(120).describe("Age (18-120)"),
            tags: z.array(z.string()).optional().describe("Optional tags"),
            metadata: z.object({
              source: z.string(),
              verified: z.boolean().optional()
            }).optional().describe("Optional metadata")
          },
          async execute({ username, email, age, tags, metadata }) {
            return {
              content: [{
                type: "text",
                text: `Zod4 validated: ${username}, ${email}, age=${age}, tags=${tags?.join(',') || 'none'}, metadata=${JSON.stringify(metadata) || 'none'}`
              }]
            };
          }
        });
        log('Tool "zod4-user-validator" registered successfully', 'success');

        // Update tools list
        const tools = await mc.listTools();
        toolsListEl.innerHTML = tools.map(t =>
          `<div style="padding: 0.5rem; background: white; border-radius: 4px; margin-bottom: 0.5rem;">
            <strong>${t.name}</strong> - ${t.description}
          </div>`
        ).join('');

        // Test 1: Valid input
        log('Test 1: Valid input...', 'info');
        const r1 = await mc.executeTool('zod4-user-validator', {
          username: "validuser",
          email: "test@example.com",
          age: 25
        });
        log(`Valid input: ${r1.isError ? 'FAILED' : 'PASSED'} - ${r1.content?.[0]?.text}`, r1.isError ? 'error' : 'success');

        // Test 2: Valid with all optional fields
        log('Test 2: Valid input with all optional fields...', 'info');
        const r2 = await mc.executeTool('zod4-user-validator', {
          username: "validuser",
          email: "test@example.com",
          age: 30,
          tags: ["tag1", "tag2"],
          metadata: { source: "web", verified: true }
        });
        log(`With optionals: ${r2.isError ? 'FAILED' : 'PASSED'} - ${r2.content?.[0]?.text}`, r2.isError ? 'error' : 'success');

        // Test 3: Missing required field
        log('Test 3: Missing required field (email)...', 'info');
        const r3 = await mc.executeTool('zod4-user-validator', {
          username: "testuser",
          age: 30
        });
        log(`Missing email: ${r3.isError ? 'PASSED (rejected)' : 'FAILED (should reject)'}`, r3.isError ? 'success' : 'error');

        // Test 4: Invalid type (age as string)
        log('Test 4: Invalid type (age as string)...', 'info');
        const r4 = await mc.executeTool('zod4-user-validator', {
          username: "testuser",
          email: "test@example.com",
          age: "twenty-five"
        });
        log(`Invalid type: ${r4.isError ? 'PASSED (rejected)' : 'FAILED (should reject)'}`, r4.isError ? 'success' : 'error');

        // Test 5: Value out of range (age too low)
        log('Test 5: Value out of range (age=15)...', 'info');
        const r5 = await mc.executeTool('zod4-user-validator', {
          username: "testuser",
          email: "test@example.com",
          age: 15
        });
        log(`Age too low: ${r5.isError ? 'PASSED (rejected)' : 'FAILED (should reject)'}`, r5.isError ? 'success' : 'error');

        // Test 6: String too short (username)
        log('Test 6: String too short (username="ab")...', 'info');
        const r6 = await mc.executeTool('zod4-user-validator', {
          username: "ab",
          email: "test@example.com",
          age: 25
        });
        log(`Username too short: ${r6.isError ? 'PASSED (rejected)' : 'FAILED (should reject)'}`, r6.isError ? 'success' : 'error');

        // Test 7: Invalid email format
        log('Test 7: Invalid email format...', 'info');
        const r7 = await mc.executeTool('zod4-user-validator', {
          username: "testuser",
          email: "not-an-email",
          age: 25
        });
        log(`Invalid email: ${r7.isError ? 'PASSED (rejected)' : 'FAILED (should reject)'}`, r7.isError ? 'success' : 'error');

        // Test 8: Invalid nested object
        log('Test 8: Invalid nested object (metadata.source as number)...', 'info');
        const r8 = await mc.executeTool('zod4-user-validator', {
          username: "testuser",
          email: "test@example.com",
          age: 25,
          metadata: { source: 123, verified: true }
        });
        log(`Invalid nested: ${r8.isError ? 'PASSED (rejected)' : 'FAILED (should reject)'}`, r8.isError ? 'success' : 'error');

        // Test 9: Invalid array item type
        log('Test 9: Invalid array item type (tags with number)...', 'info');
        const r9 = await mc.executeTool('zod4-user-validator', {
          username: "testuser",
          email: "test@example.com",
          age: 25,
          tags: ["valid", 123]
        });
        log(`Invalid array item: ${r9.isError ? 'PASSED (rejected)' : 'FAILED (should reject)'}`, r9.isError ? 'success' : 'error');

        statusEl.textContent = 'All tests completed!';
        log('All tests completed!', 'success');

      } catch (error) {
        log(`Error: ${error.message}`, 'error');
        console.error(error);
      }
    }

    // Run tests when page loads
    runTests();
  </script>
</body>
</html>
