name: Release Canary

on:
  # Manual trigger for canary releases
  workflow_dispatch:
    inputs:
      tag:
        description: 'Canary tag suffix (e.g., "canary", "alpha", "beta")'
        required: false
        default: 'canary'
        type: string

permissions:
  contents: write # For creating GitHub releases
  id-token: write # For OIDC and sigstore signing

env:
  CI: true

jobs:
  canary:
    name: Publish Canary
    # Only run on the main repository, not forks
    if: github.repository == 'WebMCP-org/npm-packages'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@c5ba7f7862a0f64c1b1a05fbac13e0b8e86ba08c # v4

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: pnpm install

      - name: Build packages
        run: pnpm build

      - name: Create canary versions
        id: versions
        run: |
          # Generate timestamp for canary version
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          TAG_SUFFIX="${{ inputs.tag || 'canary' }}"

          # Update each package version to canary format: 0.0.0-<tag>.<timestamp>
          PACKAGES_JSON="[]"
          for pkg in packages/*/; do
            if [ -f "$pkg/package.json" ]; then
              name=$(jq -r '.name' "$pkg/package.json")
              current_version=$(jq -r '.version' "$pkg/package.json")
              if [ "$name" != "null" ] && [ "$current_version" != "null" ]; then
                # Create canary version
                canary_version="${current_version}-${TAG_SUFFIX}.${TIMESTAMP}"
                # Update package.json
                jq --arg v "$canary_version" '.version = $v' "$pkg/package.json" > "$pkg/package.json.tmp"
                mv "$pkg/package.json.tmp" "$pkg/package.json"
                echo "Updated $name to $canary_version"
                # Add to packages list
                PACKAGES_JSON=$(echo "$PACKAGES_JSON" | jq -c --arg n "$name" --arg v "$canary_version" '. + [{"name": $n, "version": $v}]')
              fi
            fi
          done
          echo "packages=$PACKAGES_JSON" >> $GITHUB_OUTPUT

      - name: Publish canary packages
        run: |
          pnpm publish -r --access public --tag ${{ inputs.tag || 'canary' }} --no-git-checks
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_CONFIG_PROVENANCE: true

      - name: Install cosign
        uses: sigstore/cosign-installer@3454372f43399081ed03b604cb2d021dabca52bb # v3.8.0

      - name: Create GitHub releases and sign artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PACKAGES: ${{ steps.versions.outputs.packages }}
          TAG_SUFFIX: ${{ inputs.tag || 'canary' }}
        run: |
          echo "## Published Canary Versions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "$PACKAGES" | jq -c '.[]' | while read -r pkg; do
            PKG_NAME=$(echo "$pkg" | jq -r '.name')
            PKG_VERSION=$(echo "$pkg" | jq -r '.version')
            TAG="${PKG_NAME}@${PKG_VERSION}"

            echo "- ${PKG_NAME}@${PKG_VERSION}" >> $GITHUB_STEP_SUMMARY

            # Create safe filename (replace @ and / with -)
            SAFE_NAME=$(echo "${PKG_NAME}-${PKG_VERSION}" | sed 's/@//g' | sed 's/\//-/g')

            # Create a release tarball from the package directory
            PKG_DIR=$(echo "$PKG_NAME" | sed 's/@mcp-b\//packages\//')
            if [ -d "$PKG_DIR" ]; then
              # Create tarball of the built package
              tar -czf "/tmp/${SAFE_NAME}.tar.gz" -C "$(dirname "$PKG_DIR")" "$(basename "$PKG_DIR")"

              # Sign with cosign (keyless via OIDC)
              cosign sign-blob "/tmp/${SAFE_NAME}.tar.gz" \
                --yes \
                --output-signature "/tmp/${SAFE_NAME}.tar.gz.sig" \
                --output-certificate "/tmp/${SAFE_NAME}.tar.gz.pem" \
                --bundle "/tmp/${SAFE_NAME}.tar.gz.sigstore"

              # Create release notes file
              cat > /tmp/release-notes.md << NOTES_EOF
          Canary release of ${PKG_NAME}

          **Install:** npm install ${PKG_NAME}@${TAG_SUFFIX}

          **Verify signature:**
          cosign verify-blob ${SAFE_NAME}.tar.gz --signature ${SAFE_NAME}.tar.gz.sig --certificate ${SAFE_NAME}.tar.gz.pem --certificate-identity-regexp https://github.com/WebMCP-org/npm-packages --certificate-oidc-issuer https://token.actions.githubusercontent.com
          NOTES_EOF

              # Create GitHub release (prerelease for canary)
              gh release create "$TAG" \
                --title "${PKG_NAME} ${PKG_VERSION}" \
                --notes-file /tmp/release-notes.md \
                --prerelease \
                "/tmp/${SAFE_NAME}.tar.gz" \
                "/tmp/${SAFE_NAME}.tar.gz.sig" \
                "/tmp/${SAFE_NAME}.tar.gz.pem" \
                "/tmp/${SAFE_NAME}.tar.gz.sigstore" \
                2>/dev/null || echo "  Warning: Release may already exist for $TAG"

              echo "  Created signed release for $TAG"
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All packages signed with sigstore (keyless OIDC)" >> $GITHUB_STEP_SUMMARY
